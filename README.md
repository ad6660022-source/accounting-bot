# 💼 Бот-Бухгалтер ИП

Telegram Mini App для учёта финансов нескольких ИП.
Поддерживает личные балансы, операции, долги, сводки и управление ИП.

---

## 🚀 Быстрый старт (локально)

### Что нужно
- [Docker Desktop](https://www.docker.com/products/docker-desktop/) (запущен)
- Telegram-бот (создан через [@BotFather](https://t.me/BotFather))

### 1. Настройка `.env`

Скопируй `.env.example` → `.env` и заполни:

```env
TELEGRAM_BOT_TOKEN=твой_токен_от_BotFather
POSTGRES_PASSWORD=придумай_пароль
DATABASE_URL=postgresql+asyncpg://postgres:придумай_пароль@db:5432/accounting_bot
WEBAPP_URL=https://твой-домен.up.railway.app   # после деплоя
ADMIN_INVITE_CODE=ACC-ADMIN-2025               # код для получения прав
```

### 2. Запуск — двойной клик

| Файл | Действие |
|------|----------|
| `Запустить.bat` | Запускает всё (с окном консоли, видны логи) |
| `Запустить (без окна).vbs` | Тихий запуск — для ярлыка на рабочем столе |
| `Остановить.bat` | Останавливает все контейнеры |

> **Ярлык на рабочий стол:** ПКМ на `Запустить (без окна).vbs` → Отправить → Рабочий стол

### 3. Регистрация администратора

Отправь боту команду с кодом из `.env`:
```
/start ACC-ADMIN-2025
```
После этого смени `ADMIN_INVITE_CODE` на другой код и перезапусти бот.

---

## 📱 Mini App

Кнопка **«📱 Открыть бухгалтерию»** появляется в боте после `/start`.

**Страницы:**
- 🏠 **Главная** — личный баланс и балансы всех ИП
- ➕ **Операция** — все 8 типов финансовых операций
- 📋 **История** — лента транзакций
- 🔴 **Долги** — кто кому должен, погашение
- 📊 **Сводка** — отчёты за день / неделю / месяц / всё время
- ⚙️ **Управление** — создание ИП, управление ролями (только для админов)

---

## ⚙️ Операции

| Операция | Списание | Начисление |
|----------|----------|------------|
| 🛒 Закуп | Личный баланс | Наличные ИП |
| 💸 Посторонние траты | Личный баланс | — |
| 📥 Приход ежемесячный | — | Личный баланс |
| ⚡ Приход быстрый | — | Личный баланс |
| 🏦 Приход сторонний | — | Личный баланс |
| 💴 Снять с Р/С | Р/С ИП | Личный баланс |
| 🏛 Внести на Р/С | Личный баланс | Р/С ИП |
| 🤝 Одолжить | Личный баланс | Баланс получателя + долг |

---

## 🌐 Деплой на Railway

### 1. Подготовка GitHub
```bash
cd g:\accounting-bot
git init
git add .
git commit -m "initial commit"
git remote add origin https://github.com/ВАШ_НИК/accounting-bot.git
git push -u origin main
```

### 2. Railway
1. [railway.app](https://railway.app) → New Project → Deploy from GitHub
2. Добавь сервис **PostgreSQL** (Railway Plugin)
3. В настройках сервиса бота добавь переменные окружения:
   - `TELEGRAM_BOT_TOKEN`
   - `ADMIN_INVITE_CODE`
   - `DATABASE_URL` — скопируй из вкладки PostgreSQL (формат `postgresql+asyncpg://...`)
4. После деплоя скопируй URL сервиса (вида `https://xxx.up.railway.app`)
5. Вставь его в `WEBAPP_URL` (в Railway и в `.env` для локального теста)

### 3. Настройка Mini App в BotFather
```
/setmenubutton → выбери бота → введи URL → введи текст кнопки
```
URL: `https://твой-домен.up.railway.app`

> ⚠️ Telegram требует **HTTPS** для Mini App. Railway предоставляет его автоматически.

---

## 🏗 Архитектура

```
accounting-bot/
├── backend/
│   ├── api/            ← FastAPI (REST для Mini App)
│   ├── bot/            ← aiogram 3 (Telegram-бот)
│   ├── database/       ← SQLAlchemy 2, PostgreSQL
│   ├── services/       ← бизнес-логика
│   └── main.py         ← запускает бот + API параллельно
├── frontend/           ← React + Vite (Mini App)
├── Dockerfile          ← multi-stage: сборка фронта + Python
├── docker-compose.yml  ← бот + PostgreSQL
├── Запустить.bat       ← одним кликом на Windows
└── railway.toml        ← конфиг деплоя
```

**Порты:**
- `8000` — FastAPI API + раздача фронтенда
- `5432` — PostgreSQL (только внутри Docker)

---

## 🔑 Роли

| Роль | Права |
|------|-------|
| **Пользователь** | Операции, просмотр балансов, долги, сводки |
| **Администратор** | Всё выше + создание ИП, управление ролями пользователей |

Получить роль администратора: `/start КОД` (код из `ADMIN_INVITE_CODE` в `.env`)
